const wheel=document.getElementById("wheel"),arrow=document.getElementById("arrow"),luckDrawCountDom=document.querySelector(".luckDrawCount span"),PRIZES=[{title:"\u624b\u6c14\u4e0d\u9519\u54df\uff5e\u606d\u559c\u83b7\u5f97",prize:"\u4e00\u7b49\u5956"},{title:"\u624b\u6c14\u4e0d\u9519\u54df\uff5e\u606d\u559c\u83b7\u5f97",prize:"\u4e8c\u7b49\u5956"},{title:"\u624b\u6c14\u4e0d\u9519\u54df\uff5e\u606d\u559c\u83b7\u5f97",prize:"\u4e09\u7b49\u5956"},{title:"\u4e0b\u6b21\u518d\u6765",prize:"\u8c22\u8c22\u60e0\u987e"},{title:"\u624b\u6c14\u4e0d\u9519\u54df\uff5e\u606d\u559c\u83b7\u5f97",prize:"\u56db\u7b49\u5956"},{title:"\u624b\u6c14\u4e0d\u9519\u54df\uff5e\u606d\u559c\u83b7\u5f97",prize:"\u4e94\u7b49\u5956"},{title:"\u624b\u6c14\u4e0d\u9519\u54df\uff5e\u606d\u559c\u83b7\u5f97",prize:"\u516d\u7b49\u5956"},{title:"\u518d\u6765\u4e00\u6b21",prize:"\u8c22\u8c22\u60e0\u987e"}],COLORS=["#f31f49","#fff7d7","#a71d77"],TEXT_COLORS=["#f3f1f1","#a8213c","#f3f1f1"],ROTATE_Z=360,ROTATE_Z_COUNT=10,RUN_TIME=6,PRIZE_COUNT=PRIZES.length,PRIZE_ANGLE=360/PRIZE_COUNT,ROTATE_Z_POSITIONS=Array.from({length:PRIZE_COUNT},((e,t)=>t*PRIZE_ANGLE+PRIZE_ANGLE/2));let gameState=!1,luckDrawCount=3,currentRotation=0,lastRotation=0,lastClickTime=0;function debounce(e,t){let o;return function(){const n=this,i=arguments;clearTimeout(o),o=setTimeout((()=>e.apply(n,i)),t)}}function securityCheck(){window.self!==window.top&&(window.top.location=window.self.location)}function sendMessageToNative(e){try{window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.native?window.webkit.messageHandlers.native.postMessage(e):window.Android&&"function"==typeof window.Android.sendMessage?window.Android.sendMessage(e):console.log("\u672a\u68c0\u6d4b\u5230\u539f\u751f\u73af\u5883",e)}catch(e){console.error("\u5411\u539f\u751f\u53d1\u9001\u6d88\u606f\u65f6\u51fa\u9519:",e)}}function initWheel(){const e=document.querySelector(".wheel-inner"),t=document.querySelector("#prize-template"),o=360/PRIZES.length;PRIZES.forEach(((n,i)=>{const a=t.cloneNode(!0);a.style.display="block",a.style.transform=`rotateZ(${o/2-90+o*i}deg)`,a.querySelector(".prize-bg").style.background=COLORS[i%COLORS.length],a.querySelector(".prize-text").style.color=TEXT_COLORS[i%TEXT_COLORS.length],a.querySelector(".prize-text").textContent=n.prize;const c=o/2,l=(100-100*Math.tan(c*Math.PI/180))/2;a.style.clipPath=`polygon(0% 50%, 100% ${l}%, 100% ${100-l}%)`,e.appendChild(a)}))}function gameAction(e){const t=ROTATE_Z_POSITIONS[e],o=currentRotation-3600-t+lastRotation;requestAnimationFrame((()=>{wheel.style.transform=`rotate(${o}deg)`})),currentRotation=o,lastRotation=t,luckDrawCount--,luckDrawCountDom.innerHTML=luckDrawCount,wheel.addEventListener("transitionend",(function t(){wheel.removeEventListener("transitionend",t),gameState=!1,onDrawComplete(e)}),{once:!0})}function showModal(e){document.getElementById("modalMessage").innerText=e,document.getElementById("modal").style.display="block"}function onDrawComplete(e){showModal(PRIZES[e].title+"\r\n"+PRIZES[e].prize),sendMessageToNative({type:"drawResult",index:e,prize:PRIZES[e]})}function setLuckDrawCount(e){luckDrawCount=e,luckDrawCountDom.innerText=luckDrawCount}document.getElementById("modalClose").onclick=function(){document.getElementById("modal").style.display="none"},arrow.addEventListener("click",(function(e){const t=Date.now();t-lastClickTime<1e3?e.preventDefault():(lastClickTime=t,gameState||(luckDrawCount<=0?showModal("Sorry \u60a8\u6ca1\u6709\u62bd\u5956\u673a\u4f1a\u4e86"):(gameState=!0,gameAction(Math.floor(Math.random()*PRIZE_COUNT)))))}),!1);const optimizedResize=debounce(_resize,150);window.addEventListener("resize",optimizedResize,!1),window.addEventListener("message",(function(e){"\u4f60\u7684\u539f\u751f\u5e94\u7528\u7684\u57df\u540d"===e.origin&&"luckDrawCount"===e.data.type&&setLuckDrawCount(e.data.count)})),window.addEventListener("online",(()=>console.log("\u7f51\u7edc\u5df2\u8fde\u63a5"))),window.addEventListener("offline",(()=>showModal("\u7f51\u7edc\u8fde\u63a5\u5df2\u65ad\u5f00\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u8bbe\u7f6e"))),window.addEventListener("load",(function(){Promise.all(["./images/wheel-bg.png","./images/game-arrow.png","./images/game-bg.png"].map((e=>new Promise(((t,o)=>{const n=new Image;n.onload=t,n.onerror=o,n.src=e}))))).then((()=>{const e=document.getElementById("loading");e&&(e.classList.add("hide"),setTimeout((()=>e.remove()),300))})).catch((e=>{console.error("\u8d44\u6e90\u52a0\u8f7d\u5931\u8d25:",e);const t=document.getElementById("loading");t&&t.remove()})),initWheel()})),securityCheck();